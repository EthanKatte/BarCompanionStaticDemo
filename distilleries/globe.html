<!DOCTYPE html>

<html data-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../static/css/tailwind.output.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<title>Distillery Globe</title>
<style>
  @import url("https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap");

  /* Tier 3 - Dark Red */
  .tasting-note-fruity {
      background-color: #5e1f1f;
      color: #ffffff;
  }

  /* Tier 2 - Medium Red */
  .tasting-note-cookedfruit,
  .tasting-note-berry,
  .tasting-note-tropical,
  .tasting-note-stonefruit,
  .tasting-note-fruit {
      background-color: #8c3434;
      color: #ffffff;
  }

  /* Tier 1 - Light Red */
  .tasting-note-marmalade,
  .tasting-note-jam,
  .tasting-note-applepie,
  .tasting-note-raspberry,
  .tasting-note-blackberry,
  .tasting-note-blueberry,
  .tasting-note-strawberry,
  .tasting-note-orange,
  .tasting-note-lemon,
  .tasting-note-orangepeel,
  .tasting-note-coconut,
  .tasting-note-banana,
  .tasting-note-plum,
  .tasting-note-peach,
  .tasting-note-cherry,
  .tasting-note-apricot,
  .tasting-note-raisin,
  .tasting-note-grape,
  .tasting-note-fig,
  .tasting-note-apple {
      background-color: #e5a3a3;
      color: #333333;
  }

  /* Greens Theme */

  /* Tier 3 - Dark Green */
  .tasting-note-spice {
      background-color: #1f4d3a;
      color: #ffffff;
  }

  /* Tier 2 - Medium Green */
  .tasting-note-bakingspice,
  .tasting-note-savoryspice {
      background-color: #347d5e;
      color: #ffffff;
  }

  /* Tier 1 - Light Green */
  .tasting-note-nutmeg,
  .tasting-note-clove,
  .tasting-note-coriander,
  .tasting-note-cinnamon,
  .tasting-note-staranise,
  .tasting-note-whitepepper,
  .tasting-note-spearmint,
  .tasting-note-herbal,
  .tasting-note-fennel,
  .tasting-note-dill,
  .tasting-note-blackpepper {
      background-color: #a3d5c1;
      color: #333333;
  }


  /* Blues Theme */

  /* Tier 3 - Dark Blue */
  .tasting-note-sweet {
      background-color: #1f3a5e;
      color: #ffffff;
  }

  /* Tier 2 - Medium Blue */
  .tasting-note-vanillas,
  .tasting-note-soda,
  .tasting-note-dessert,
  .tasting-note-chocolates {
      background-color: #345e8c;
      color: #ffffff;
  }

  /* Tier 1 - Light Blue */
  .tasting-note-vanilla,
  .tasting-note-custard,
  .tasting-note-cremebrulee,
  .tasting-note-cherrysoda,
  .tasting-note-cremesoda,
  .tasting-note-rootbeer,
  .tasting-note-cola,
  .tasting-note-brownsugar,
  .tasting-note-butterscotch,
  .tasting-note-caramel,
  .tasting-note-grahamcracker,
  .tasting-note-honey,
  .tasting-note-licorice,
  .tasting-note-maplesyrup,
  .tasting-note-marshmellow,
  .tasting-note-molasses,
  .tasting-note-toffee,
  .tasting-note-bitterchocolate,
  .tasting-note-milkchocolate,
  .tasting-note-chocolatemocha,
  .tasting-note-chocolatemilk {
      background-color: #a3c1e5;
      color: #333333;
  }


  /* Yellows Theme */

  /* Tier 3 - Dark Yellow */
  .tasting-note-grain {
      background-color: #7a5e1f;
      color: #ffffff;
  }

  /* Tier 2 - Medium Yellow */
  .tasting-note-corn,
  .tasting-note-malt,
  .tasting-note-rye,
  .tasting-note-bread {
      background-color: #b38b34;
      color: #ffffff;
  }

  /* Tier 1 - Light Yellow */
  .tasting-note-cereal,
  .tasting-note-cocoa,
  .tasting-note-bread,
  .tasting-note-buckwheatpancakes {
      background-color: #e5c585;
      color: #333333;
  }

  /* Browns Theme */

  /* Tier 3 - Dark Brown */
  .tasting-note-wood {
      background-color: #5a4033;
      color: #ffffff;
  }

  /* Tier 2 - Medium Brown */
  .tasting-note-oak,
  .tasting-note-pine,
  .tasting-note-nut,
  .tasting-note-earthy {
      background-color: #8c5b44;
      color: #ffffff;
  }

  /* Tier 1 - Light Brown */
  .tasting-note-smokyoak,
  .tasting-note-sweetoak,
  .tasting-note-toastedoak,
  .tasting-note-cedar,
  .tasting-note-almond,
  .tasting-note-hazelnut,
  .tasting-note-peanut,
  .tasting-note-pecan,
  .tasting-note-walnut,
  .tasting-note-coffee,
  .tasting-note-leather,
  .tasting-note-tobacco,
  .tasting-note-peat,
  .tasting-note-smoke {
      background-color: #d4b7a3;
      color: #333333;
  }


  /* Pinks Theme */

  /* Tier 3 - Dark Pink */
  .tasting-note-floral {
      background-color: #7a244f;
      color: #ffffff;
  }

  /* Tier 1 - Light Pink */
  .tasting-note-rose,
  .tasting-note-heather,
  .tasting-note-violet {
      background-color: #e6a5c1;
      color: #333333;
  }

  :root {
      --catalog-ink: #1f2a2e;
      --catalog-muted: #5c6a6a;
      --catalog-panel: #f9f6f1;
      --catalog-panel-strong: #f1e7db;
      --catalog-accent: #c79257;
      --catalog-accent-strong: #9c4e1b;
      --catalog-border: rgba(31, 42, 46, 0.12);
  }

  .catalog-shell {
      position: relative;
      overflow: hidden;
      border-radius: 28px;
      padding: clamp(1.5rem, 3vw, 2.75rem);
      background:
          radial-gradient(circle at top right, rgba(199, 146, 87, 0.22), transparent 55%),
          radial-gradient(circle at 10% 20%, rgba(31, 42, 46, 0.08), transparent 50%),
          linear-gradient(135deg, #fdfbf7 0%, #f3eee6 100%);
      border: 1px solid var(--catalog-border);
  }

  .catalog-orb {
      position: absolute;
      border-radius: 999px;
      opacity: 0.7;
      animation: catalog-float 12s ease-in-out infinite;
      pointer-events: none;
  }

  html {
      scrollbar-width: auto;
      scrollbar-color: var(--catalog-accent-strong) transparent;
  }

  *::-webkit-scrollbar {
      width: 10px;
  }

  *::-webkit-scrollbar-track {
      background: transparent;
  }

  *::-webkit-scrollbar-thumb {
      background-color: var(--catalog-accent-strong);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: content-box;
  }

  *::-webkit-scrollbar-thumb:hover {
      background-color: var(--catalog-accent);
  }

  .catalog-orb--a {
      width: 260px;
      height: 260px;
      top: -120px;
      right: -80px;
      background: radial-gradient(circle, rgba(156, 78, 27, 0.28), transparent 65%);
  }

  .catalog-orb--b {
      width: 320px;
      height: 320px;
      bottom: -180px;
      left: -140px;
      animation-delay: 4s;
      background: radial-gradient(circle, rgba(199, 146, 87, 0.22), transparent 70%);
  }

  .catalog-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 2rem;
  }

  .catalog-hero {
      display: flex;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
  }

  .catalog-title {
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: clamp(2.4rem, 3.2vw, 3.2rem);
      color: var(--catalog-ink);
      margin: 0;
  }

  .catalog-eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--catalog-accent-strong);
      margin-bottom: 0.75rem;
  }

  .catalog-subtitle {
      font-family: "Source Sans 3", "Segoe UI", sans-serif;
      color: var(--catalog-muted);
      max-width: 36rem;
      margin-top: 0.5rem;
  }

  .catalog-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-self: flex-start;
  }

  .catalog-btn {
      font-weight: 600;
      letter-spacing: 0.02em;
  }

  .catalog-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  @media (min-width: 1280px) {
  .catalog-stats {
        grid-template-columns: repeat(4, minmax(140px, 1fr));
    }
  }

  .catalog-stat {
      background: var(--catalog-panel);
      border-radius: 16px;
      border: 1px solid var(--catalog-border);
      padding: 0.75rem 1rem;
  }



  .catalog-stat__label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--catalog-muted);
  }

  .catalog-stat__value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--catalog-ink);
  }

  .catalog-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      align-items: center;
      background: var(--catalog-panel);
      border-radius: 20px;
      border: 1px solid var(--catalog-border);
      padding: 1.25rem;
  }

  .catalog-controls--inventory {
      grid-template-columns: minmax(300px, 500px) auto auto;
  }

  .catalog-search {
      display: grid;
      gap: 0.6rem;
  }

  .catalog-search__label {
      font-weight: 600;
      color: var(--catalog-ink);
  }

  .catalog-search__meta {
      font-size: 0.85rem;
      color: var(--catalog-muted);
  }

  .catalog-search__input {
      width: 100%;
  }

  .catalog-controls__actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
  }

  .catalog-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: var(--catalog-ink);
  }

  .catalog-toggle-group {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.75rem 1rem;
      align-items: center;
      justify-content: center;
      align-self: center;
  }

  .catalog-filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
  }

  .catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.5rem;
  }

  .catalog-card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid var(--catalog-border);
      box-shadow: 0 18px 40px rgba(18, 26, 32, 0.08);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .catalog-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 26px 50px rgba(18, 26, 32, 0.14);
  }

  .catalog-card.is-unavailable {
      opacity: 0.3;
  }

  .catalog-card__click {
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
  }

  .catalog-card__media {
      position: relative;
      background: linear-gradient(120deg, rgba(199, 146, 87, 0.2), rgba(255, 255, 255, 0.9));
      border-radius: 20px 20px 0 0;
      padding: 1.5rem 1rem 1rem;
  }

  .catalog-card__media img {
      width: 100%;
      height: 210px;
      object-fit: contain;
  }

  .catalog-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 700;
      color: #fff;
  }

  .catalog-badge--available {
      background: var(--catalog-accent-strong);
  }

  .catalog-badge--unavailable {
      background: #6f7a7a;
  }

  .catalog-badge--special {
      background: var(--fallback-s, oklch(var(--s)/1));
      color: var(--fallback-sc, oklch(var(--sc)/1));
  }

  .catalog-card__body {
      padding: 1.25rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
  }

  .catalog-card__header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
  }

  .catalog-card__brand {
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: 1.2rem;
      margin: 0;
      color: var(--catalog-ink);
  }

  .catalog-card__abv {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--catalog-muted);
  }

  .catalog-card__name {
      margin: 0;
      font-size: 0.95rem;
      color: var(--catalog-ink);
  }

  .catalog-card__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
  }

  .catalog-chip {
      background: var(--catalog-panel-strong);
      color: var(--catalog-ink);
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 600;
  }

  .catalog-chip--muted {
      background: #ffffff;
      border: 1px solid var(--catalog-border);
  }

  @keyframes catalog-float {
      0% { transform: translateY(0); }
      50% { transform: translateY(12px); }
      100% { transform: translateY(0); }
  }

  @media (max-width: 900px) {
      .catalog-hero {
          flex-direction: column;
          align-items: flex-start;
      }
  }

  @media (max-width: 640px) {
      .catalog-actions {
          width: 100%;
      }

      .catalog-actions .btn {
          flex: 1;
      }

      .catalog-controls {
          grid-template-columns: 1fr;
      }
  }

  @media (prefers-reduced-motion: reduce) {
      .catalog-orb {
          animation: none;
      }

      .catalog-card {
          transition: none;
      }
  }
  </style>
</head>
<body class="bg-base h-screen overflow-x-hidden">
<!-- Navigation Bar -->
<nav class="bg-primary text-white p-4 flex items-center justify-between">
<!-- Left-aligned Screensaver Button -->
<div class="flex items-center">
<a class="hover:underline flex items-center" href="../index.html">
<i class="fas fa-tv text-3xl"></i>
</a>
</div>
<!-- Centered Navigation Links -->
<ul class="flex justify-center space-x-6">
<li>
<a class="hover:underline flex items-center" href="../home.html">
<i class="fas fa-home text-3xl"></i>
</a>
</li>
<li>
<a class="hover:underline flex items-center" href="../inventory.html">
<i class="fas fa-boxes text-3xl"></i>
</a>
</li>
<li>
<a class="hover:underline flex items-center" href="../distilleries.html">
<i class="fas fa-industry text-3xl"></i>
</a>
</li>
<li>
<a class="hover:underline flex items-center" href="../users.html">
<i class="fas fa-users text-3xl"></i>
</a>
</li>
<li>
<a class="hover:underline flex items-center" href="../events.html">
<i class="fas fa-calendar-days text-3xl"></i>
</a>
</li>
</ul>
<!-- Placeholder for Right Alignment -->
<div></div>
</nav>
<div class="absolute fixed top-4 right-4 space-y-4 z-[9999]" id="alert-container"></div>
<!-- Main Content -->
<div class="container mx-auto py-8">
<div class="catalog-content globe-fullscreen">
<div class="globe-stage">
<div class="globe-overlay">
<div class="globe-overlay__actions">
<a class="btn btn-primary btn-sm" href="../distilleries.html">List view</a>
</div>
</div>
<canvas aria-label="Interactive distillery globe" id="distillery-globe"></canvas>
<div aria-hidden="true" class="globe-tooltip" id="globe-tooltip"></div>
</div>
<div class="globe-panel">
<div class="globe-panel__details" id="globe-details">
<p class="text-sm text-gray-500">No distillery selected yet.</p>
</div>
</div>
</div>
<style>
  :root {
    --globe-ocean-1: var(--catalog-panel-strong);
    --globe-ocean-2: #1f4f73;
    --globe-ocean-3: #16384f;
    --globe-ring: rgba(199, 146, 87, 0.45);
    --globe-grid: rgba(31, 42, 46, 0.12);
    --globe-land: rgba(46, 132, 82, 0.45);
    --globe-border: rgba(31, 42, 46, 0.22);
    --globe-marker: var(--catalog-accent-strong);
    --globe-marker-glow: rgba(199, 146, 87, 0.35);
    --globe-marker-selected: var(--catalog-ink);
    --globe-marker-selected-glow: rgba(31, 42, 46, 0.24);
    --globe-tooltip-bg: var(--catalog-panel);
    --globe-tooltip-text: var(--catalog-ink);
  }

  body {
    overflow: hidden;
    overscroll-behavior: none;
  }

  .globe-fullscreen {
    width: 100vw;
    margin-left: calc(50% - 50vw);
    padding: 0 24px 24px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(280px, 360px);
    gap: 24px;
    min-height: calc(100vh - 96px);
    align-items: stretch;
  }

  .globe-stage {
    position: relative;
    height: 100%;
    min-height: calc(100vh - 140px);
    border-radius: 24px;
    background: radial-gradient(
      120% 120% at 20% 10%,
      var(--globe-ocean-1) 0%,
      var(--globe-ocean-2) 55%,
      var(--globe-ocean-3) 100%
    );
    overflow: hidden;
    border: 1px solid var(--globe-border);
  }

  #distillery-globe {
    width: 100%;
    height: 100%;
    display: block;
    touch-action: none;
  }

  .globe-tooltip {
    position: absolute;
    pointer-events: none;
    padding: 8px 12px;
    border-radius: 999px;
    background: var(--globe-tooltip-bg);
    color: var(--globe-tooltip-text);
    font-size: 13px;
    opacity: 0;
    transform: translate(-50%, -130%);
    transition: opacity 120ms ease, transform 120ms ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
  }

  .globe-tooltip.is-visible {
    opacity: 1;
    transform: translate(-50%, -160%);
  }

  .globe-overlay {
    position: absolute;
    top: 18px;
    left: 18px;
    right: 18px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    z-index: 2;
    pointer-events: none;
  }

  .globe-overlay__card {
    background: var(--catalog-panel);
    border: 1px solid var(--catalog-border);
    border-radius: 16px;
    padding: 12px 14px;
    color: var(--catalog-ink);
    backdrop-filter: blur(4px);
    max-width: 340px;
  }

  .globe-overlay__actions {
    pointer-events: auto;
  }

  .globe-overlay__eyebrow {
    font-size: 11px;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--catalog-accent-strong);
  }

  .globe-overlay__title {
    font-size: 20px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  .globe-overlay__subtitle {
    margin-top: 6px;
    font-size: 13px;
    color: var(--catalog-muted);
  }

  .globe-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: calc(100vh - 140px);
    max-height: calc(100vh - 140px);
    overflow: hidden;
  }

  .globe-panel__title {
    font-size: 18px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .globe-panel__subtitle {
    margin-top: 4px;
    color: var(--catalog-muted);
    font-size: 13px;
  }

  .globe-panel__details {
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--catalog-border);
    background: var(--catalog-panel-strong);
    overflow-y: auto;
    flex: 1;
    min-height: 0;
  }

  .globe-panel__media {
    width: 100%;
    height: 140px;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(31, 42, 46, 0.06);
    border: 1px solid var(--catalog-border);
  }

  .globe-panel__media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .globe-panel__bottles {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(72px, 1fr));
    gap: 10px;
  }

  .globe-panel__bottle {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
    text-align: center;
    font-size: 11px;
    color: var(--catalog-muted);
  }

  .globe-panel__bottle img {
    width: 64px;
    height: 64px;
    border-radius: 10px;
    object-fit: cover;
    background: rgba(31, 42, 46, 0.08);
  }

  .globe-panel__bottle-placeholder {
    width: 64px;
    height: 64px;
    border-radius: 10px;
    background: rgba(31, 42, 46, 0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--catalog-muted);
  }

  .globe-panel__browse {
    display: grid;
    gap: 8px;
    max-height: 100%;
    overflow-y: auto;
    padding-right: 4px;
  }

  .globe-panel__caption {
    font-size: 11px;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: var(--catalog-accent-strong);
  }

  .globe-panel__list {
    display: grid;
    gap: 10px;
    flex: 1;
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  .globe-panel__item {
    display: grid;
    gap: 4px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--catalog-border);
    background: var(--catalog-panel-strong);
    text-align: left;
    color: inherit;
    font: inherit;
    cursor: pointer;
    transition: border-color 140ms ease, background 140ms ease;
  }

  .globe-panel__item:hover {
    border-color: var(--catalog-accent);
    background: #fffaf3;
  }

  .globe-panel__item-title {
    font-weight: 700;
    letter-spacing: 0.04em;
  }

  .globe-panel__item-meta {
    font-size: 12px;
    color: var(--catalog-muted);
  }

  @media (max-width: 960px) {
    .globe-fullscreen {
      grid-template-columns: 1fr;
      padding: 0 16px 24px;
      min-height: auto;
    }

    .globe-stage {
      min-height: 60vh;
    }

    .globe-panel {
      min-height: auto;
      max-height: none;
    }

    .globe-overlay {
      left: 12px;
      right: 12px;
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<script>
  const WORLD_ATLAS_URL =
    "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

  const distilleries = [{"bottles": [{"abv": "52%", "brand": "Archie Rose", "id": 1, "image_path": "archie_rose_blasphemy.jpg", "name": "Blasphemy", "spirit_type": "Whiskey", "subtype": "Blended"}, {"abv": "46%", "brand": "Archie Rose", "id": 2, "image_path": "archie_rose_classic.jpg", "name": "Opera House - Classical", "spirit_type": "Whiskey", "subtype": "Single Malt"}, {"abv": "46%", "brand": "Archie Rose", "id": 3, "image_path": "archie_rose_contemporary.jpg", "name": "Opera House - Contemporary", "spirit_type": "Whiskey", "subtype": "Single Malt"}, {"abv": "48%", "brand": "Archie Rose", "id": 4, "image_path": "archie_rose_rum_cask.jpg", "name": "Rum Cask Single Malt", "spirit_type": "Whiskey", "subtype": "Single Malt"}, {"abv": "46%", "brand": "Archie Rose", "id": 5, "image_path": "archie_rose_rye.jpg", "name": "Rye", "spirit_type": "Whiskey", "subtype": "Rye"}, {"abv": "46%", "brand": "Archie Rose", "id": 6, "image_path": "archie_rose_single_malt.jpg", "name": "Single Malt", "spirit_type": "Whiskey", "subtype": "Single Malt"}, {"abv": "50%", "brand": "Archie Rose", "id": 7, "image_path": "archie_rose_six_malt.jpg", "name": "Six Malt New Make", "spirit_type": "Whiskey", "subtype": "New Make Spirit"}, {"abv": "40%", "brand": "Archie Rose", "id": 89, "image_path": "Archie_Rose_test.png", "name": "test", "spirit_type": "Whiskey", "subtype": "Blended"}], "country": "Australia", "description": "Archie Rose\u2019s primary production distillery commissioned around 2020 in the Botany/Banksmeadow industrial precinct, housing larger custom copper pot stills and expanded mash, fermentation and bottling capacity for its whiskies, gins and liqueurs. Separate from the original Rosebery bar/distillery.", "id": 1, "image_path": "distilleries/Archie_Rose_Distilling_Co._\u2013_Botany_(Banksmeadow)_Distillery.jpg", "lat": -33.9542459, "lon": 151.2157073, "name": "Archie Rose Distilling Co. \u2013 Botany (Banksmeadow) Distillery", "region": "New South Wales"}, {"bottles": [{"abv": "51.5%", "brand": "Blanton\u0027s", "id": 11, "image_path": "blantons_gold.jpg", "name": "Gold", "spirit_type": "Whiskey", "subtype": "Bourbon"}, {"abv": "46.5%", "brand": "Blanton\u0027s", "id": 10, "image_path": "blantons_private_reserve.jpg", "name": "Private Reserve", "spirit_type": "Whiskey", "subtype": "Bourbon"}, {"abv": "40%", "brand": "Blanton\u0027s", "id": 9, "image_path": "blantons_special_reserve.jpg", "name": "Special Reserve", "spirit_type": "Whiskey", "subtype": "Bourbon"}], "country": "United States", "description": "Historic Sazerac-owned distillery on the Kentucky River, long known as George T. Stagg/Ancient Age, producing bourbon and rye; it also distills and matures Blanton\u2019s under contract.", "id": 3, "image_path": "distilleries/Buffalo_Trace_Distillery.jpg", "lat": 38.214748, "lon": -84.868212, "name": "Buffalo Trace Distillery", "region": "Kentucky"}, {"bottles": [{"abv": "40%", "brand": "Casamigos", "id": 49, "image_path": "casamigos_mezcal.jpg", "name": "Mezcal", "spirit_type": "Mezcal", "subtype": null}], "country": "Mexico", "description": "Large, modern industrial mezcal distillery (palenque) known for high-volume production and contract distilling; primary site associated with brands like Zignum and other third-party mezcals.", "id": 8, "image_path": "distilleries/Casa_Armando_Guillermo_Prieto_(AGP).jpg", "lat": null, "lon": null, "name": "Casa Armando Guillermo Prieto (AGP)", "region": "Oaxaca"}, {"bottles": [{"abv": "40%", "brand": "Cragganmore", "id": 12, "image_path": "cragganmore_12.jpg", "name": "12 Year Old", "spirit_type": "Whiskey", "subtype": "Single Malt"}, {"abv": "40%", "brand": "Cragganmore", "id": 13, "image_path": "cragganmore_distillers_2023.jpg", "name": "Distillers Edition", "spirit_type": "Whiskey", "subtype": "Scotch"}], "country": "Scotland", "description": "Historic Speyside single malt distillery founded in 1869 on the River Spey, known for worm-tub condensers; owned by Diageo.", "id": 9, "image_path": "distilleries/Cragganmore_Distillery.jpg", "lat": 57.41009, "lon": -3.39436, "name": "Cragganmore Distillery", "region": "Speyside (Moray)"}, {"bottles": [{"abv": "40%", "brand": "Espolon", "id": 46, "image_path": "espolon_reposado.jpg", "name": "Reposada Tequila", "spirit_type": "Tequila", "subtype": null}], "country": "Mexico", "description": "Primary Campari Group tequila distillery in Los Altos (NOM 1440), a modern high-capacity site producing Espol\u00f2n with autoclave cooking, roller milling, and pot distillation.", "id": 12, "image_path": "distilleries/Destiladora_San_Nicolas_S.A._de_C.V_12.jpg", "lat": 20.7008848, "lon": -102.5394048, "name": "Destiladora San Nicol\u00e1s, S.A. de C.V.", "region": "Jalisco"}, {"bottles": [{"abv": "38%", "brand": "Sierra", "id": 47, "image_path": "sierra_tequila.jpg", "name": "Tequila", "spirit_type": "Tequila", "subtype": null}], "country": "Mexico", "description": "Tequila distillery on the outskirts of Tequila in the valley region, operating as the primary production site for the Sierra line.", "id": 16, "image_path": "distilleries/Destileria_Sierra_S.A._de_C.V_16.jpg", "lat": -38.0440259, "lon": -57.5274042, "name": "Destiler\u00eda Sierra, S.A. de C.V.", "region": "Jalisco"}, {"bottles": [{"abv": "40%", "brand": "Drambuie", "id": 20, "image_path": "drambuie.jpg", "name": "Honey Whiskey", "spirit_type": "Liqueur", "subtype": null}], "country": "Scotland, United Kingdom", "description": "Large integrated grain distillery and blending/bottling complex owned by William Grant \u0026 Sons; primary production hub that includes the Girvan grain site and Ailsa Bay malt distillery.", "id": 11, "image_path": "distilleries/Girvan_Distillery.jpg", "lat": 55.2638144, "lon": -4.8337491, "name": "Girvan Distillery", "region": "South Ayrshire"}, {"bottles": [{"abv": "40%", "brand": "Husk", "id": 55, "image_path": "husk_botanic.jpg", "name": "Botanic", "spirit_type": "Rum", "subtype": null}, {"abv": "40%", "brand": "Husk", "id": 56, "image_path": "husk_pure_cane.jpg", "name": "Pure Cane", "spirit_type": "Rum", "subtype": null}, {"abv": "40%", "brand": "Husk", "id": 54, "image_path": "husk_bam_bam.jpg", "name": "Spiced Bam Bam", "spirit_type": "Rum", "subtype": null}, {"abv": "40%", "brand": "Ink", "id": 40, "image_path": "ink_art_gin.jpg", "name": "Art Gin", "spirit_type": "Gin", "subtype": null}, {"abv": "40%", "brand": "Ink", "id": 39, "image_path": "ink_orange_gin.jpg", "name": "Bitter Orange Gin", "spirit_type": "Gin", "subtype": null}, {"abv": "40%", "brand": "Ink", "id": 38, "image_path": "ink_gin.jpg", "name": "Gin", "spirit_type": "Gin", "subtype": null}], "country": "Australia", "description": "Farm-based cane-juice rum and gin distillery on a rural estate with on-site sugarcane cultivation and a visitor centre; primary production site for Husk Distillers.", "id": 13, "image_path": "distilleries/Husk_Farm_Distillery_(Husk_Distillers).jpg", "lat": -28.2681972, "lon": 153.473187, "name": "Husk Farm Distillery (Husk Distillers)", "region": "New South Wales"}, {"bottles": [{"abv": "40%", "brand": "Jack Daniel\u0027s", "id": 15, "image_path": "jack_daniels_no_7.jpg", "name": "Old No.7", "spirit_type": "Whiskey", "subtype": "American whiskey"}, {"abv": "45%", "brand": "Jack Daniel\u0027s", "id": 21, "image_path": "jack_daniels_single_barrell.jpg", "name": "Single Barrel", "spirit_type": "Whiskey", "subtype": "American whiskey"}], "country": "United States", "description": "Historic Tennessee whiskey distillery centered around Cave Spring Hollow in Lynchburg; sole production site for Jack Daniel\u2019s using the Lincoln County Process with extensive maturation warehouses on-site.", "id": 15, "image_path": "distilleries/Jack_Daniel_Distillery_Lem_Motlow_Prop._Inc_15.jpg", "lat": 35.2836001, "lon": -86.3699474, "name": "Jack Daniel Distillery (Lem Motlow, Prop., Inc.)", "region": "Tennessee"}];
  const globeDistilleries = distilleries
    .filter((distillery) => distillery.lat && distillery.lon)
    .map((distillery) => ({
      ...distillery,
      lat: parseFloat(distillery.lat),
      lon: parseFloat(distillery.lon),
    }));

  const canvas = document.getElementById("distillery-globe");
  const ctx = canvas.getContext("2d");
  const tooltip = document.getElementById("globe-tooltip");
  const list = document.getElementById("globe-list");
  const details = document.getElementById("globe-details");
  let countriesGeo = null;
  let bordersGeo = null;
  const theme = getGlobeTheme();

  const state = {
    width: 0,
    height: 0,
    centerX: 0,
    centerY: 0,
    radius: 0,
    rotLat: 0.1,
    rotLon: -0.8,
    dragging: false,
    lastX: 0,
    lastY: 0,
    dragDistance: 0,
    zoom: 1,
    pinching: false,
    pinchStartDistance: 0,
    pinchStartZoom: 1,
    ignoreClick: false,
  };

  let projectedMarkers = [];
  let selectedId = null;
  let lastTime = 0;
  const pointers = new Map();

  function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
  }

  function getThemeValue(variable, fallback) {
    const value = getComputedStyle(document.documentElement)
      .getPropertyValue(variable)
      .trim();
    return value || fallback;
  }

  function getGlobeTheme() {
    return {
      ocean1: getThemeValue("--globe-ocean-1", "#f1e7db"),
      ocean2: getThemeValue("--globe-ocean-2", "#f9f6f1"),
      ocean3: getThemeValue("--globe-ocean-3", "#e7d6c5"),
      ring: getThemeValue("--globe-ring", "rgba(199, 146, 87, 0.45)"),
      grid: getThemeValue("--globe-grid", "rgba(31, 42, 46, 0.12)"),
      land: getThemeValue("--globe-land", "rgba(31, 42, 46, 0.18)"),
      border: getThemeValue("--globe-border", "rgba(31, 42, 46, 0.22)"),
      marker: getThemeValue("--globe-marker", "#9c4e1b"),
      markerGlow: getThemeValue("--globe-marker-glow", "rgba(199, 146, 87, 0.35)"),
      markerSelected: getThemeValue("--globe-marker-selected", "#1f2a2e"),
      markerSelectedGlow: getThemeValue("--globe-marker-selected-glow", "rgba(31, 42, 46, 0.24)"),
    };
  }

  function toRad(deg) {
    return (deg * Math.PI) / 180;
  }

  function latLonToVector(lat, lon) {
    const latRad = toRad(lat);
    const lonRad = toRad(lon);
    return {
      x: Math.cos(latRad) * Math.sin(lonRad),
      y: Math.sin(latRad),
      z: Math.cos(latRad) * Math.cos(lonRad),
    };
  }

  function rotateY(v, angle) {
    const cos = Math.cos(angle);
    const sin = Math.sin(angle);
    return {
      x: v.x * cos + v.z * sin,
      y: v.y,
      z: -v.x * sin + v.z * cos,
    };
  }

  function rotateX(v, angle) {
    const cos = Math.cos(angle);
    const sin = Math.sin(angle);
    return {
      x: v.x,
      y: v.y * cos - v.z * sin,
      z: v.y * sin + v.z * cos,
    };
  }

  function project(lat, lon) {
    let v = latLonToVector(lat, lon);
    v = rotateY(v, state.rotLon);
    v = rotateX(v, state.rotLat);
    return {
      x: state.centerX + v.x * state.radius,
      y: state.centerY - v.y * state.radius,
      z: v.z,
      visible: v.z > 0,
    };
  }

  function resize() {
    const dpr = window.devicePixelRatio || 1;
    state.width = canvas.parentElement.clientWidth;
    state.height = canvas.parentElement.clientHeight;
    canvas.width = state.width * dpr;
    canvas.height = state.height * dpr;
    canvas.style.width = `${state.width}px`;
    canvas.style.height = `${state.height}px`;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    state.centerX = state.width / 2;
    state.centerY = state.height / 2;
    state.radius = Math.min(state.width, state.height) * 0.38 * state.zoom;
  }

  function drawGlobe() {
    const gradient = ctx.createRadialGradient(
      state.centerX - state.radius * 0.4,
      state.centerY - state.radius * 0.4,
      state.radius * 0.2,
      state.centerX,
      state.centerY,
      state.radius * 1.2
    );
    gradient.addColorStop(0, theme.ocean1);
    gradient.addColorStop(0.55, theme.ocean2);
    gradient.addColorStop(1, theme.ocean3);

    ctx.beginPath();
    ctx.arc(state.centerX, state.centerY, state.radius, 0, Math.PI * 2);
    ctx.fillStyle = gradient;
    ctx.fill();

    ctx.save();
    ctx.beginPath();
    ctx.arc(state.centerX, state.centerY, state.radius + 1.5, 0, Math.PI * 2);
    ctx.strokeStyle = theme.ring;
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  function strokeRing(ring) {
    let started = false;
    ctx.beginPath();

    for (const [lon, lat] of ring) {
      const point = project(lat, lon);
      if (!point.visible) {
        started = false;
        continue;
      }
      if (!started) {
        ctx.moveTo(point.x, point.y);
        started = true;
      } else {
        ctx.lineTo(point.x, point.y);
      }
    }

    if (started) {
      ctx.stroke();
    }
  }

  function fillRing(ring) {
    let started = false;
    ctx.beginPath();

    for (const [lon, lat] of ring) {
      const point = project(lat, lon);
      if (!point.visible) {
        started = false;
        continue;
      }
      if (!started) {
        ctx.moveTo(point.x, point.y);
        started = true;
      } else {
        ctx.lineTo(point.x, point.y);
      }
    }

    if (started) {
      ctx.closePath();
      ctx.fill();
    }
  }

  function strokeLine(line) {
    let started = false;
    ctx.beginPath();

    for (const [lon, lat] of line) {
      const point = project(lat, lon);
      if (!point.visible) {
        started = false;
        continue;
      }
      if (!started) {
        ctx.moveTo(point.x, point.y);
        started = true;
      } else {
        ctx.lineTo(point.x, point.y);
      }
    }

    if (started) {
      ctx.stroke();
    }
  }

  function drawLand() {
    if (!countriesGeo) {
      return;
    }

    ctx.save();
    ctx.fillStyle = theme.land;
    ctx.strokeStyle = theme.land;
    ctx.lineWidth = 1;

    for (const feature of countriesGeo.features) {
      const geometry = feature.geometry;
      if (geometry.type === "Polygon") {
        for (const ring of geometry.coordinates) {
          fillRing(ring);
        }
      } else if (geometry.type === "MultiPolygon") {
        for (const polygon of geometry.coordinates) {
          for (const ring of polygon) {
            fillRing(ring);
          }
        }
      }
    }

    for (const feature of countriesGeo.features) {
      const geometry = feature.geometry;
      if (geometry.type === "Polygon") {
        for (const ring of geometry.coordinates) {
          strokeRing(ring);
        }
      } else if (geometry.type === "MultiPolygon") {
        for (const polygon of geometry.coordinates) {
          for (const ring of polygon) {
            strokeRing(ring);
          }
        }
      }
    }

    if (bordersGeo && bordersGeo.coordinates) {
      ctx.strokeStyle = theme.border;
      ctx.lineWidth = 0.8;
      for (const line of bordersGeo.coordinates) {
        strokeLine(line);
      }
    }

    ctx.restore();
  }

  function drawGrid() {
    ctx.save();
    ctx.strokeStyle = theme.grid;
    ctx.lineWidth = 1;
    for (let lat = -60; lat <= 60; lat += 30) {
      drawLatitude(lat);
    }
    for (let lon = -150; lon <= 180; lon += 30) {
      drawLongitude(lon);
    }
    ctx.restore();
  }

  function drawLatitude(lat) {
    ctx.beginPath();
    let started = false;
    for (let lon = -180; lon <= 180; lon += 4) {
      const point = project(lat, lon);
      if (point.visible) {
        if (!started) {
          ctx.moveTo(point.x, point.y);
          started = true;
        } else {
          ctx.lineTo(point.x, point.y);
        }
      } else {
        started = false;
      }
    }
    ctx.stroke();
  }

  function drawLongitude(lon) {
    ctx.beginPath();
    let started = false;
    for (let lat = -90; lat <= 90; lat += 4) {
      const point = project(lat, lon);
      if (point.visible) {
        if (!started) {
          ctx.moveTo(point.x, point.y);
          started = true;
        } else {
          ctx.lineTo(point.x, point.y);
        }
      } else {
        started = false;
      }
    }
    ctx.stroke();
  }

  function drawMarkers(time) {
    projectedMarkers = [];
    globeDistilleries.forEach((distillery, index) => {
      const point = project(distillery.lat, distillery.lon);
      projectedMarkers.push({ ...distillery, ...point });
      if (!point.visible) {
        return;
      }

      const pulse = 0.6 + 0.4 * Math.sin(time * 0.004 + index);
      const size = 4 + point.z * 6;
      const isSelected = distillery.id === selectedId;

      ctx.save();
      ctx.beginPath();
      ctx.arc(point.x, point.y, size * 2.2 * pulse, 0, Math.PI * 2);
      ctx.fillStyle = isSelected ? theme.markerSelectedGlow : theme.markerGlow;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(point.x, point.y, size * (isSelected ? 1.4 : 1), 0, Math.PI * 2);
      ctx.fillStyle = isSelected ? theme.markerSelected : theme.marker;
      ctx.fill();
      ctx.restore();
    });
  }

  function render(time) {
    const delta = time - lastTime;
    lastTime = time;

    //if (!state.dragging) {
    //  state.rotLon += delta * 0.00003;
    //}

    ctx.clearRect(0, 0, state.width, state.height);
    drawGlobe();
    drawLand();
    drawGrid();
    drawMarkers(time);
    requestAnimationFrame(render);
  }

  function showTooltip(marker, x, y) {
    tooltip.textContent = `${marker.name} - ${marker.region || "Region pending"}`;
    tooltip.style.left = `${x}px`;
    tooltip.style.top = `${y}px`;
    tooltip.classList.add("is-visible");
    tooltip.setAttribute("aria-hidden", "false");
  }

  function hideTooltip() {
    tooltip.classList.remove("is-visible");
    tooltip.setAttribute("aria-hidden", "true");
  }

  function handleHover(event) {
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    let nearest = null;
    let nearestDist = 18;

    projectedMarkers.forEach((marker) => {
      if (!marker.visible) {
        return;
      }
      const dx = marker.x - x;
      const dy = marker.y - y;
      const dist = Math.hypot(dx, dy);
      if (dist < nearestDist) {
        nearest = marker;
        nearestDist = dist;
      }
    });

    if (nearest) {
      showTooltip(nearest, nearest.x, nearest.y);
    } else {
      hideTooltip();
    }
  }

  function updateDetails(distillery) {
    if (!distillery) {
      const browseList = globeDistilleries
        .map(
          (entry) => `
            <button class="globe-panel__item" type="button" data-id="${entry.id}">
              <span class="globe-panel__item-title">${entry.name}</span>
              <span class="globe-panel__item-meta">${entry.region || "Region pending"}, ${entry.country || "Country pending"}</span>
            </button>
          `
        )
        .join("");

      details.innerHTML = `
        <div class="space-y-3">
          <div class="globe-panel__caption">Browse distilleries</div>
          <div class="globe-panel__browse">
            ${browseList || '<p class="text-sm text-gray-500">No distilleries with coordinates.</p>'}
          </div>
        </div>
      `;
      if (list) {
        list.hidden = true;
        list.setAttribute("aria-hidden", "true");
      }
      return;
    }

    if (list) {
      list.hidden = false;
      list.setAttribute("aria-hidden", "false");
    }

    const location = `${distillery.region || "Region pending"}, ${distillery.country || "Country pending"}`;
    const description = distillery.description || "Description pending.";
    const bottles = Array.isArray(distillery.bottles) ? distillery.bottles : [];
    const bottlePreview = bottles.slice(0, 8);
    const remainingCount = bottles.length - bottlePreview.length;
    const bottleMarkup = bottlePreview
      .map((bottle) => {
        if (bottle.image_path) {
          return `
            <div class="globe-panel__bottle">
              <img src="/database_images/bottles/${bottle.image_path}" alt="${bottle.name}" />
              <span>${bottle.name}</span>
            </div>
          `;
        }
        return `
          <div class="globe-panel__bottle">
            <div class="globe-panel__bottle-placeholder">No image</div>
            <span>${bottle.name}</span>
          </div>
        `;
      })
      .join("");

    const distilleryImage = distillery.image_path
      ? `
        <div class="globe-panel__media">
          <img src="/database_images/${distillery.image_path}" alt="${distillery.name}" />
        </div>
      `
      : "";

    details.innerHTML = `
      <div class="space-y-2">
        ${distilleryImage}
        <div class="text-lg font-semibold">${distillery.name}</div>
        <div class="text-sm text-gray-600">${location}</div>
        <p class="text-sm text-gray-600">${description}</p>
        <div class="space-y-2 pt-2">
          <div class="text-sm font-semibold text-gray-700">Bottles</div>
          ${bottleMarkup ? `<div class="globe-panel__bottles">${bottleMarkup}</div>` : '<p class="text-sm text-gray-500">No bottles linked yet.</p>'}
          ${remainingCount > 0 ? `<p class="text-xs text-gray-500">+${remainingCount} more bottles</p>` : ""}
        </div>
      </div>
    `;
  }

  function bindList() {
    if (!list) {
      return;
    }

    if (!globeDistilleries.length) {
      list.innerHTML = "<p class=\"text-sm text-gray-400\">No distilleries with coordinates.</p>";
      return;
    }

    list.innerHTML = globeDistilleries
      .map(
        (distillery) => `
        <button class="globe-panel__item" type="button" data-id="${distillery.id}">
          <span class="globe-panel__item-title">${distillery.name}</span>
          <span class="globe-panel__item-meta">${distillery.region || "Region pending"}, ${distillery.country || "Country pending"}</span>
        </button>
      `
      )
      .join("");
  }

  function focusDistillery(distillery) {
    selectedId = distillery.id;
    state.rotLat = clamp(toRad(distillery.lat), -1.2, 1.2);
    state.rotLon = -toRad(distillery.lon);
    updateDetails(distillery);
  }

  function clearFocus() {
    if (selectedId === null) {
      return;
    }
    selectedId = null;
    updateDetails(null);
    hideTooltip();
  }

  function handleListClick(event) {
    const item = event.target.closest(".globe-panel__item");
    if (!item) {
      return;
    }
    const distillery = globeDistilleries.find((entry) => String(entry.id) === item.dataset.id);
    if (!distillery) {
      return;
    }
    focusDistillery(distillery);
  }

  if (details) {
    details.addEventListener("click", handleListClick);
  }

  if (list) {
    list.addEventListener("click", handleListClick);
  }

  canvas.addEventListener("pointerdown", (event) => {
    pointers.set(event.pointerId, { x: event.clientX, y: event.clientY });
    state.dragging = true;
    state.lastX = event.clientX;
    state.lastY = event.clientY;
    state.dragDistance = 0;
    canvas.setPointerCapture(event.pointerId);

    if (pointers.size === 2) {
      const [a, b] = Array.from(pointers.values());
      state.pinching = true;
      state.pinchStartDistance = Math.hypot(a.x - b.x, a.y - b.y);
      state.pinchStartZoom = state.zoom;
      state.ignoreClick = true;
      state.dragging = false;
    }
  });

  canvas.addEventListener("pointermove", (event) => {
    if (event.pointerType === "touch") {
      event.preventDefault();
    }
    if (pointers.has(event.pointerId)) {
      pointers.set(event.pointerId, { x: event.clientX, y: event.clientY });
    }

    if (state.pinching && pointers.size >= 2) {
      const [a, b] = Array.from(pointers.values());
      const distance = Math.hypot(a.x - b.x, a.y - b.y);
      if (state.pinchStartDistance > 0) {
        const scale = distance / state.pinchStartDistance;
        state.zoom = clamp(state.pinchStartZoom * scale, 0.7, 4);
        resize();
      }
      return;
    }
    if (!state.dragging) {
      handleHover(event);
      return;
    }
    const dx = event.clientX - state.lastX;
    const dy = event.clientY - state.lastY;
    state.lastX = event.clientX;
    state.lastY = event.clientY;
    state.dragDistance += Math.hypot(dx, dy);
    if (state.dragDistance > 6) {
      clearFocus();
    }

    state.rotLon += dx * 0.005;
    state.rotLat = clamp(state.rotLat + dy * 0.005, -1.2, 1.2);
  });

  canvas.addEventListener("pointerup", (event) => {
    state.dragging = false;
    pointers.delete(event.pointerId);
    if (pointers.size < 2) {
      state.pinching = false;
    }
  });

  canvas.addEventListener("pointerleave", (event) => {
    state.dragging = false;
    pointers.delete(event.pointerId);
    if (pointers.size < 2) {
      state.pinching = false;
    }
    hideTooltip();
  });

  canvas.addEventListener("pointercancel", (event) => {
    state.dragging = false;
    pointers.delete(event.pointerId);
    if (pointers.size < 2) {
      state.pinching = false;
    }
  });

  canvas.addEventListener("click", (event) => {
    if (state.ignoreClick) {
      state.ignoreClick = false;
      return;
    }
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    let nearest = null;
    let nearestDist = 18;

    projectedMarkers.forEach((marker) => {
      if (!marker.visible) {
        return;
      }
      const dx = marker.x - x;
      const dy = marker.y - y;
      const dist = Math.hypot(dx, dy);
      if (dist < nearestDist) {
        nearest = marker;
        nearestDist = dist;
      }
    });

    if (nearest) {
      if (selectedId === nearest.id) {
        clearFocus();
      } else {
        focusDistillery(nearest);
      }
    } else {
      clearFocus();
    }
  });

  canvas.addEventListener(
    "wheel",
    (event) => {
      event.preventDefault();
      const delta = Math.sign(event.deltaY) * -0.06;
      state.zoom = clamp(state.zoom + delta, 0.7, 4);
      resize();
    },
    { passive: false }
  );

  window.addEventListener("resize", resize);

  async function loadWorld() {
    if (typeof topojson === "undefined") {
      console.warn("TopoJSON client not available, skipping land overlay.");
      return;
    }

    try {
      const response = await fetch(WORLD_ATLAS_URL);
      if (!response.ok) {
        throw new Error(`World atlas fetch failed: ${response.status}`);
      }

      const topo = await response.json();
      const countriesObj = topo.objects && topo.objects.countries;
      if (!countriesObj) {
        throw new Error("World atlas data missing countries object.");
      }

      countriesGeo = topojson.feature(topo, countriesObj);
      bordersGeo = topojson.mesh(topo, countriesObj, (a, b) => a !== b);
    } catch (error) {
      console.error("Failed to load world atlas data:", error);
    }
  }
      //  <div class="globe-overlay__card">
      //  <p class="globe-overlay__eyebrow">Distillery atlas</p>
      //  <h1 class="globe-overlay__title">Globe View</h1>
      //  <p class="globe-overlay__subtitle">
      //    Spin the globe to explore distilleries by location and tap markers for details.
      //  </p>
      //</div>

  updateDetails(null);
  bindList();
  resize();
  loadWorld();
  requestAnimationFrame(render);
</script>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[9999]" id="loading-overlay">
<div class="text-white text-3xl">Processing...</div>
</div>
</body>
<script>
  function showLoadingOverlay() {
    document.getElementById("loading-overlay").classList.remove("hidden");
  }

  function hideLoadingOverlay() {
    document.getElementById("loading-overlay").classList.add("hidden");
  }

  function showAlert(message, type = "info", timeout = 3000) {
    // Create the alert element
    const alert = document.createElement("div");
    alert.className = `alert alert-${type} shadow-lg`;
    alert.role = "alert"

    // Add alert content
    alert.innerHTML = `
      <div>
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          ${
            type === "success"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />'
              : type === "error"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />'
              : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" />'
          }
        </svg>
        <span>${message}</span>
      </div>
    `;

    // Add alert to the container
    const alertContainer = document.getElementById("alert-container");
    alertContainer.appendChild(alert);

    // Automatically remove the alert after the timeout
    setTimeout(() => {
      alert.remove();
    }, timeout);
  }
</script>
</html>